const W=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],b=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],pe=["REQUIRED","OPTIONAL","REPEATED"],Ie=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],be=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],te=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],ne={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)}};function Q(e,t,n,i){if(t&&n.endsWith("_DICTIONARY")){let r=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(r=new t.constructor(e.length));for(let f=0;f<e.length;f++)r[f]=t[e[f]];return r}else return re(e,i)}function re(e,t){const{element:n,parsers:i,utf8:r=!0}=t,{type:f,converted_type:s,logical_type:o}=n;if(s==="DECIMAL"){const a=10**-(n.scale||0),l=new Array(e.length);for(let c=0;c<l.length;c++)e[c]instanceof Uint8Array?l[c]=ie(e[c])*a:l[c]=Number(e[c])*a;return l}if(!s&&f==="INT96"){const u=new Array(e.length);for(let a=0;a<u.length;a++)u[a]=i.timestampFromNanoseconds(ve(e[a]));return u}if(s==="DATE"){const u=new Array(e.length);for(let a=0;a<u.length;a++)u[a]=i.dateFromDays(e[a]);return u}if(s==="TIMESTAMP_MILLIS"){const u=new Array(e.length);for(let a=0;a<u.length;a++)u[a]=i.timestampFromMilliseconds(e[a]);return u}if(s==="TIMESTAMP_MICROS"){const u=new Array(e.length);for(let a=0;a<u.length;a++)u[a]=i.timestampFromMicroseconds(e[a]);return u}if(s==="JSON"){const u=new TextDecoder;return e.map(a=>JSON.parse(u.decode(a)))}if(s==="BSON")throw new Error("parquet bson not supported");if(s==="INTERVAL")throw new Error("parquet interval not supported");if(s==="UTF8"||(o==null?void 0:o.type)==="STRING"||r&&f==="BYTE_ARRAY"){const u=new TextDecoder,a=new Array(e.length);for(let l=0;l<a.length;l++)a[l]=e[l]&&u.decode(e[l]);return a}if(s==="UINT_64"||(o==null?void 0:o.type)==="INTEGER"&&o.bitWidth===64&&!o.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);const u=new BigUint64Array(e.length);for(let a=0;a<u.length;a++)u[a]=BigInt(e[a]);return u}if(s==="UINT_32"||(o==null?void 0:o.type)==="INTEGER"&&o.bitWidth===32&&!o.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);const u=new Uint32Array(e.length);for(let a=0;a<u.length;a++)u[a]=e[a];return u}if((o==null?void 0:o.type)==="FLOAT16")return Array.from(e).map(fe);if((o==null?void 0:o.type)==="TIMESTAMP"){const{unit:u}=o;let a=i.timestampFromMilliseconds;u==="MICROS"&&(a=i.timestampFromMicroseconds),u==="NANOS"&&(a=i.timestampFromNanoseconds);const l=new Array(e.length);for(let c=0;c<l.length;c++)l[c]=a(e[c]);return l}return e}function ie(e){if(!e.length)return 0;let t=0n;for(const i of e)t=t*256n+BigInt(i);const n=e.length*8;return t>=2n**BigInt(n-1)&&(t-=2n**BigInt(n)),Number(t)}function ve(e){const t=(e>>64n)-2440588n,n=e&0xffffffffffffffffn;return t*86400000000000n+n}function fe(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,i=t>>10&31,r=t&1023;return i===0?n*2**-14*(r/1024):i===31?r?NaN:n*(1/0):n*2**(i-15)*(1+r/1024)}function se(e,t,n){const i=e[t],r=[];let f=1;if(i.num_children)for(;r.length<i.num_children;){const s=e[t+f],o=se(e,t+f,[...n,s.name]);f+=o.count,r.push(o)}return{count:f,element:i,children:r,path:n}}function oe(e,t){let n=se(e,0,[]);const i=[n];for(const r of t){const f=n.children.find(s=>s.element.name===r);if(!f)throw new Error(`parquet schema element not found: ${t}`);i.push(f),n=f}return i}function le(e){let t=0;for(const{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function Y(e){let t=0;for(const{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function Le(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function Ne(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;const t=e.children[0];if(t.children.length!==2||t.element.repetition_type!=="REPEATED")return!1;const n=t.children.find(r=>r.element.name==="key");if((n==null?void 0:n.element.repetition_type)==="REPEATED")return!1;const i=t.children.find(r=>r.element.name==="value");return(i==null?void 0:i.element.repetition_type)!=="REPEATED"}function ue(e){if(e.length!==2)return!1;const[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}const y={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,STRUCT:12};function ae(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[i,r,f]=_e(e,t);if(t=f,i===y.STOP)break;n[`field_${r}`]=S(e,i)}return n}function S(e,t){switch(t){case y.TRUE:return!0;case y.FALSE:return!1;case y.BYTE:return e.view.getInt8(e.offset++);case y.I16:case y.I32:return Te(e);case y.I64:return q(e);case y.DOUBLE:{const n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case y.BINARY:{const n=v(e),i=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,i}case y.LIST:{const[n,i]=Oe(e),r=n===y.TRUE||n===y.FALSE,f=new Array(i);for(let s=0;s<i;s++)f[s]=r?S(e,y.BYTE)===1:S(e,n);return f}case y.STRUCT:{const n={};let i=0;for(;;){let r,f;if([r,f,i]=_e(e,i),r===y.STOP)break;n[`field_${f}`]=S(e,r)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function v(e){let t=0,n=0;for(;;){const i=e.view.getUint8(e.offset++);if(t|=(i&127)<<n,!(i&128))return t;n+=7}}function Re(e){let t=0n,n=0n;for(;;){const i=e.view.getUint8(e.offset++);if(t|=BigInt(i&127)<<n,!(i&128))return t;n+=7n}}function Te(e){const t=v(e);return t>>>1^-(t&1)}function q(e){const t=Re(e);return t>>1n^-(t&1n)}function ce(e){return e&15}function _e(e,t){const n=e.view.getUint8(e.offset++);if((n&15)===y.STOP)return[0,0,t];const i=n>>4;let r;if(i)r=t+i;else throw new Error("non-delta field id not supported");return[ce(n),r,r]}function Oe(e){const t=e.view.getUint8(e.offset++),n=t>>4,i=ce(t);if(n===15){const r=v(e);return[i,r]}return[i,n]}const De=1<<19;async function x(e,{parsers:t,initialFetchSize:n=De}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");const i=Math.max(0,e.byteLength-n),r=await e.slice(i,e.byteLength),f=new DataView(r);if(f.getUint32(r.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const s=f.getUint32(r.byteLength-8,!0);if(s>e.byteLength-8)throw new Error(`parquet metadata length ${s} exceeds available buffer ${e.byteLength-8}`);if(s+8>n){const o=e.byteLength-s-8,u=await e.slice(o,i),a=new ArrayBuffer(s+8),l=new Uint8Array(a);return l.set(new Uint8Array(u)),l.set(new Uint8Array(r),i-o),Z(a,{parsers:t})}else return Z(r,{parsers:t})}function Z(e,{parsers:t}={}){var m;if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");const n=new DataView(e);if(t={...ne,...t},n.byteLength<8)throw new Error("parquet file is too short");if(n.getUint32(n.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const i=n.byteLength-8,r=n.getUint32(i,!0);if(r>n.byteLength-8)throw new Error(`parquet metadata length ${r} exceeds available buffer ${n.byteLength-8}`);const f=i-r,o=ae({view:n,offset:f}),u=new TextDecoder;function a(w){return w&&u.decode(w)}const l=o.field_1,c=o.field_2.map(w=>({type:W[w.field_1],type_length:w.field_2,repetition_type:pe[w.field_3],name:a(w.field_4),num_children:w.field_5,converted_type:Ie[w.field_6],scale:w.field_7,precision:w.field_8,field_id:w.field_9,logical_type:Se(w.field_10)})),_=c.filter(w=>w.type),d=o.field_3,h=o.field_4.map(w=>{var p;return{columns:w.field_1.map((g,ye)=>{var z,G;return{file_path:a(g.field_1),file_offset:g.field_2,meta_data:g.field_3&&{type:W[g.field_3.field_1],encodings:(z=g.field_3.field_2)==null?void 0:z.map(R=>b[R]),path_in_schema:g.field_3.field_3.map(a),codec:be[g.field_3.field_4],num_values:g.field_3.field_5,total_uncompressed_size:g.field_3.field_6,total_compressed_size:g.field_3.field_7,key_value_metadata:g.field_3.field_8,data_page_offset:g.field_3.field_9,index_page_offset:g.field_3.field_10,dictionary_page_offset:g.field_3.field_11,statistics:Pe(g.field_3.field_12,_[ye],t),encoding_stats:(G=g.field_3.field_13)==null?void 0:G.map(R=>({page_type:te[R.field_1],encoding:b[R.field_2],count:R.field_3})),bloom_filter_offset:g.field_3.field_14,bloom_filter_length:g.field_3.field_15,size_statistics:g.field_3.field_16&&{unencoded_byte_array_data_bytes:g.field_3.field_16.field_1,repetition_level_histogram:g.field_3.field_16.field_2,definition_level_histogram:g.field_3.field_16.field_3}},offset_index_offset:g.field_4,offset_index_length:g.field_5,column_index_offset:g.field_6,column_index_length:g.field_7,crypto_metadata:g.field_8,encrypted_column_metadata:g.field_9}}),total_byte_size:w.field_2,num_rows:w.field_3,sorting_columns:(p=w.field_4)==null?void 0:p.map(g=>({column_idx:g.field_1,descending:g.field_2,nulls_first:g.field_3})),file_offset:w.field_5,total_compressed_size:w.field_6,ordinal:w.field_7}}),E=(m=o.field_5)==null?void 0:m.map(w=>({key:a(w.field_1),value:a(w.field_2)})),A=a(o.field_6);return{version:l,schema:c,num_rows:d,row_groups:h,key_value_metadata:E,created_by:A,metadata_length:r}}function k({schema:e}){return oe(e,[])[0]}function Se(e){return e!=null&&e.field_1?{type:"STRING"}:e!=null&&e.field_2?{type:"MAP"}:e!=null&&e.field_3?{type:"LIST"}:e!=null&&e.field_4?{type:"ENUM"}:e!=null&&e.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e!=null&&e.field_6?{type:"DATE"}:e!=null&&e.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:H(e.field_7.field_2)}:e!=null&&e.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:H(e.field_8.field_2)}:e!=null&&e.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e!=null&&e.field_11?{type:"NULL"}:e!=null&&e.field_12?{type:"JSON"}:e!=null&&e.field_13?{type:"BSON"}:e!=null&&e.field_14?{type:"UUID"}:e!=null&&e.field_15?{type:"FLOAT16"}:e}function H(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function Pe(e,t,n){return e&&{max:D(e.field_1,t,n),min:D(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:D(e.field_5,t,n),min_value:D(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function D(e,t,n){const{type:i,converted_type:r,logical_type:f}=t;if(e===void 0)return e;if(i==="BOOLEAN")return e[0]===1;if(i==="BYTE_ARRAY")return new TextDecoder().decode(e);const s=new DataView(e.buffer,e.byteOffset,e.byteLength);return i==="FLOAT"&&s.byteLength===4?s.getFloat32(0,!0):i==="DOUBLE"&&s.byteLength===8?s.getFloat64(0,!0):i==="INT32"&&r==="DATE"?n.dateFromDays(s.getInt32(0,!0)):i==="INT64"&&r==="TIMESTAMP_MILLIS"?n.timestampFromMilliseconds(s.getBigInt64(0,!0)):i==="INT64"&&r==="TIMESTAMP_MICROS"?n.timestampFromMicroseconds(s.getBigInt64(0,!0)):i==="INT64"&&(f==null?void 0:f.type)==="TIMESTAMP"&&(f==null?void 0:f.unit)==="NANOS"?n.timestampFromNanoseconds(s.getBigInt64(0,!0)):i==="INT64"&&(f==null?void 0:f.type)==="TIMESTAMP"&&(f==null?void 0:f.unit)==="MICROS"?n.timestampFromMicroseconds(s.getBigInt64(0,!0)):i==="INT64"&&(f==null?void 0:f.type)==="TIMESTAMP"?n.timestampFromMilliseconds(s.getBigInt64(0,!0)):i==="INT32"&&s.byteLength===4?s.getInt32(0,!0):i==="INT64"&&s.byteLength===8?s.getBigInt64(0,!0):r==="DECIMAL"?ie(e)*10**-(t.scale||0):(f==null?void 0:f.type)==="FLOAT16"?fe(e):e}function j(e,t){for(let i=0;i<t.length;i+=1e4)e.push(...t.slice(i,i+1e4))}function N(e,t){return e===t?!0:e instanceof Uint8Array&&t instanceof Uint8Array?N(Array.from(e),Array.from(t)):!e||!t||typeof e!=typeof t?!1:Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every((n,i)=>N(n,t[i])):typeof e=="object"&&Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every(n=>N(e[n],t[n]))}async function Be(e,t,n){return await(n??globalThis.fetch)(e,{...t,method:"HEAD"}).then(r=>{if(!r.ok)throw new Error(`fetch head failed ${r.status}`);const f=r.headers.get("Content-Length");if(!f)throw new Error("missing content length");return parseInt(f)})}async function at({url:e,byteLength:t,requestInit:n,fetch:i}){if(!e)throw new Error("missing url");const r=i??globalThis.fetch;t||(t=await Be(e,n,r));let f;const s=n||{};return{byteLength:t,async slice(o,u){if(f)return f.then(_=>_.slice(o,u));const a=new Headers(s.headers),l=u===void 0?"":u-1;a.set("Range",`bytes=${o}-${l}`);const c=await r(e,{...s,headers:a});if(!c.ok||!c.body)throw new Error(`fetch failed ${c.status}`);if(c.status===200)return f=c.arrayBuffer(),f.then(_=>_.slice(o,u));if(c.status===206)return c.arrayBuffer();throw new Error(`fetch received unexpected status code ${c.status}`)}}}function M(e){if(!e)return[];if(e.length===1)return e[0];const t=[];for(const n of e)j(t,n);return t}const Ue=1<<25;function Me({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:i}){var o,u;if(!e)throw new Error("parquetPlan requires metadata");const r=[],f=[];let s=0;for(const a of e.row_groups){const l=Number(a.num_rows),c=s+l;if(l>0&&c>=t&&s<n){const _=[];for(const{file_path:A,meta_data:m}of a.columns){if(A)throw new Error("parquet file_path not supported");if(!m)throw new Error("parquet column metadata is undefined");(!i||i.includes(m.path_in_schema[0]))&&_.push(de(m))}const d=Math.max(t-s,0),h=Math.min(n-s,l);r.push({ranges:_,rowGroup:a,groupStart:s,groupRows:l,selectStart:d,selectEnd:h});const E=((o=_[_.length-1])==null?void 0:o.endByte)-((u=_[0])==null?void 0:u.startByte);if(!i&&E<Ue)f.push({startByte:_[0].startByte,endByte:_[_.length-1].endByte});else if(_.length)j(f,_);else if(i!=null&&i.length)throw new Error(`parquet columns not found: ${i.join(", ")}`)}s=c}return isFinite(n)||(n=s),{metadata:e,rowStart:t,rowEnd:n,columns:i,fetches:f,groups:r}}function de({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){const i=e||t;return{startByte:Number(i),endByte:Number(i+n)}}function xe(e,{fetches:t}){const n=t.map(({startByte:i,endByte:r})=>e.slice(i,r));return{byteLength:e.byteLength,slice(i,r=e.byteLength){const f=t.findIndex(({startByte:s,endByte:o})=>s<=i&&r<=o);if(f<0)throw new Error(`no prefetch for range [${i}, ${r}]`);if(t[f].startByte!==i||t[f].endByte!==r){const s=i-t[f].startByte,o=r-t[f].startByte;return n[f]instanceof Promise?n[f].then(u=>u.slice(s,o)):n[f].slice(s,o)}else return n[f]}}}function K(e,t,n,i,r){const f=(t==null?void 0:t.length)||n.length;if(!f)return i;const s=Y(r),o=r.map(({element:h})=>h.repetition_type);let u=0;const a=[e];let l=e,c=0,_=0,d=0;if(n[0])for(;c<o.length-2&&d<n[0];)c++,o[c]!=="REQUIRED"&&(l=l.at(-1),a.push(l),_++),o[c]==="REPEATED"&&d++;for(let h=0;h<f;h++){const E=t!=null&&t.length?t[h]:s,A=n[h];for(;c&&(A<d||o[c]!=="REPEATED");)o[c]!=="REQUIRED"&&(a.pop(),_--),o[c]==="REPEATED"&&d--,c--;for(l=a.at(-1);(c<o.length-2||o[c+1]==="REPEATED")&&(_<E||o[c+1]==="REQUIRED");){if(c++,o[c]!=="REQUIRED"){const m=[];l.push(m),l=m,a.push(m),_++}o[c]==="REPEATED"&&d++}E===s?l.push(i[u++]):c===o.length-2?l.push(null):l.push([])}if(!e.length)for(let h=0;h<s;h++){const E=[];l.push(E),l=E}return e}function T(e,t,n=0){const i=t.path.join("."),r=t.element.repetition_type==="OPTIONAL",f=r?n+1:n;if(Le(t)){let s=t.children[0],o=f;s.children.length===1&&(s=s.children[0],o++),T(e,s,o);const u=s.path.join("."),a=e.get(u);if(!a)throw new Error("parquet list column missing values");r&&P(a,n),e.set(i,a),e.delete(u);return}if(Ne(t)){const s=t.children[0].element.name;T(e,t.children[0].children[0],f+1),T(e,t.children[0].children[1],f+1);const o=e.get(`${i}.${s}.key`),u=e.get(`${i}.${s}.value`);if(!o)throw new Error("parquet map column missing keys");if(!u)throw new Error("parquet map column missing values");if(o.length!==u.length)throw new Error("parquet map column key/value length mismatch");const a=he(o,u,f);r&&P(a,n),e.delete(`${i}.${s}.key`),e.delete(`${i}.${s}.value`),e.set(i,a);return}if(t.children.length){const s=t.element.repetition_type==="REQUIRED"?n:n+1,o={};for(const a of t.children){T(e,a,s);const l=e.get(a.path.join("."));if(!l)throw new Error("parquet struct missing child data");o[a.element.name]=l}for(const a of t.children)e.delete(a.path.join("."));const u=we(o,s);r&&P(u,n),e.set(i,u)}}function P(e,t){for(let n=0;n<e.length;n++)t?P(e[n],t-1):e[n]=e[n][0]}function he(e,t,n){const i=[];for(let r=0;r<e.length;r++)if(n)i.push(he(e[r],t[r],n-1));else if(e[r]){const f={};for(let s=0;s<e[r].length;s++){const o=t[r][s];f[e[r][s]]=o===void 0?null:o}i.push(f)}else i.push(void 0);return i}function we(e,t){var f;const n=Object.keys(e),i=(f=e[n[0]])==null?void 0:f.length,r=[];for(let s=0;s<i;s++){const o={};for(const u of n){if(e[u].length!==i)throw new Error("parquet struct parsing error");o[u]=e[u][s]}t?r.push(we(o,t-1)):r.push(o)}return r}function O(e,t,n){const i=n instanceof Int32Array,r=v(e),f=v(e);v(e);let s=q(e),o=0;n[o++]=i?Number(s):s;const u=r/f;for(;o<t;){const a=q(e),l=new Uint8Array(f);for(let c=0;c<f;c++)l[c]=e.view.getUint8(e.offset++);for(let c=0;c<f&&o<t;c++){const _=BigInt(l[c]);if(_){let d=0n,h=u;const E=(1n<<_)-1n;for(;h&&o<t;){let A=BigInt(e.view.getUint8(e.offset))>>d&E;for(d+=_;d>=8;)d-=8n,e.offset++,d&&(A|=BigInt(e.view.getUint8(e.offset))<<_-d&E);const m=a+A;s+=m,n[o++]=i?Number(s):s,h--}h&&(e.offset+=Math.ceil((h*Number(_)+Number(d))/8))}else for(let d=0;d<u&&o<t;d++)s+=a,n[o++]=i?Number(s):s}}}function me(e,t,n){const i=new Int32Array(t);O(e,t,i);for(let r=0;r<t;r++)n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[r]),e.offset+=i[r]}function $e(e,t,n){const i=new Int32Array(t);O(e,t,i);const r=new Int32Array(t);O(e,t,r);for(let f=0;f<t;f++){const s=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[f]);i[f]?(n[f]=new Uint8Array(i[f]+r[f]),n[f].set(n[f-1].subarray(0,i[f])),n[f].set(s,i[f])):n[f]=s,e.offset+=r[f]}}function $(e){return 32-Math.clz32(e)}function I(e,t,n,i){i===void 0&&(i=e.view.getUint32(e.offset,!0),e.offset+=4);const r=e.offset;let f=0;for(;f<n.length;){const s=v(e);if(s&1)f=qe(e,s,t,n,f);else{const o=s>>>1;Fe(e,o,t,n,f),f+=o}}e.offset=r+i}function Fe(e,t,n,i,r){const f=n+7>>3;let s=0;for(let o=0;o<f;o++)s|=e.view.getUint8(e.offset++)<<(o<<3);for(let o=0;o<t;o++)i[r+o]=s}function qe(e,t,n,i,r){let f=t>>1<<3;const s=(1<<n)-1;let o=0;if(e.offset<e.view.byteLength)o=e.view.getUint8(e.offset++);else if(s)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let u=8,a=0;for(;f;)a>8?(a-=8,u-=8,o>>>=8):u-a<n?(o|=e.view.getUint8(e.offset)<<u,e.offset++,u+=8):(r<i.length&&(i[r++]=o>>a&s),f--,a+=n);return r}function Ae(e,t,n,i){const r=Ce(n,i),f=new Uint8Array(t*r);for(let s=0;s<r;s++)for(let o=0;o<t;o++)f[o*r+s]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(f.buffer);if(n==="DOUBLE")return new Float64Array(f.buffer);if(n==="INT32")return new Int32Array(f.buffer);if(n==="INT64")return new BigInt64Array(f.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){const s=new Array(t);for(let o=0;o<t;o++)s[o]=f.subarray(o*r,(o+1)*r);return s}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function Ce(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function V(e,t,n,i){if(n===0)return[];if(t==="BOOLEAN")return Ye(e,n);if(t==="INT32")return ke(e,n);if(t==="INT64")return je(e,n);if(t==="INT96")return Ve(e,n);if(t==="FLOAT")return ze(e,n);if(t==="DOUBLE")return Ge(e,n);if(t==="BYTE_ARRAY")return We(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!i)throw new Error("parquet missing fixed length");return Qe(e,n,i)}else throw new Error(`parquet unhandled type: ${t}`)}function Ye(e,t){const n=new Array(t);for(let i=0;i<t;i++){const r=e.offset+(i/8|0),f=i%8,s=e.view.getUint8(r);n[i]=(s&1<<f)!==0}return e.offset+=Math.ceil(t/8),n}function ke(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(F(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function je(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(F(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function Ve(e,t){const n=new Array(t);for(let i=0;i<t;i++){const r=e.view.getBigInt64(e.offset+i*12,!0),f=e.view.getInt32(e.offset+i*12+8,!0);n[i]=BigInt(f)<<64n|r}return e.offset+=t*12,n}function ze(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(F(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Ge(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(F(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function We(e,t){const n=new Array(t);for(let i=0;i<t;i++){const r=e.view.getUint32(e.offset,!0);e.offset+=4,n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r),e.offset+=r}return n}function Qe(e,t,n){const i=new Array(t);for(let r=0;r<t;r++)i[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return i}function F(e,t,n){const i=new ArrayBuffer(n);return new Uint8Array(i).set(new Uint8Array(e,t,n)),i}const Ze=[0,255,65535,16777215,4294967295];function X(e,t,n,i,r){for(let f=0;f<r;f++)n[i+f]=e[t+f]}function He(e,t){const n=e.byteLength,i=t.byteLength;let r=0,f=0;for(;r<n;){const s=e[r];if(r++,s<128)break}if(i&&r>=n)throw new Error("invalid snappy length header");for(;r<n;){const s=e[r];let o=0;if(r++,r>=n)throw new Error("missing eof marker");if((s&3)===0){let u=(s>>>2)+1;if(u>60){if(r+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const a=u-60;u=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+(e[r+3]<<24),u=(u&Ze[a])+1,r+=a}if(r+u>n)throw new Error("snappy error literal exceeds input length");X(e,r,t,f,u),r+=u,f+=u}else{let u=0;switch(s&3){case 1:o=(s>>>2&7)+4,u=e[r]+(s>>>5<<8),r++;break;case 2:if(n<=r+1)throw new Error("snappy error end of input");o=(s>>>2)+1,u=e[r]+(e[r+1]<<8),r+=2;break;case 3:if(n<=r+3)throw new Error("snappy error end of input");o=(s>>>2)+1,u=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+(e[r+3]<<24),r+=4;break}if(u===0||isNaN(u))throw new Error(`invalid offset ${u} pos ${r} inputLength ${n}`);if(u>f)throw new Error("cannot copy from before start of buffer");X(t,f-u,t,f,o),f+=o}}if(f!==i)throw new Error("premature end of input")}function Ke(e,t,{type:n,element:i,schemaPath:r}){const f=new DataView(e.buffer,e.byteOffset,e.byteLength),s={view:f,offset:0};let o;const u=Xe(s,t,r),{definitionLevels:a,numNulls:l}=Je(s,t,r),c=t.num_values-l;if(t.encoding==="PLAIN")o=V(s,n,c,i.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){const _=n==="BOOLEAN"?1:f.getUint8(s.offset++);_?(o=new Array(c),n==="BOOLEAN"?(I(s,_,o),o=o.map(d=>!!d)):I(s,_,o,f.byteLength-s.offset)):o=new Uint8Array(c)}else if(t.encoding==="BYTE_STREAM_SPLIT")o=Ae(s,c,n,i.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")o=n==="INT32"?new Int32Array(c):new BigInt64Array(c),O(s,c,o);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")o=new Array(c),me(s,c,o);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:a,repetitionLevels:u,dataPage:o}}function Xe(e,t,n){if(n.length>1){const i=le(n);if(i){const r=new Array(t.num_values);return I(e,$(i),r),r}}return[]}function Je(e,t,n){const i=Y(n);if(!i)return{definitionLevels:[],numNulls:0};const r=new Array(t.num_values);I(e,$(i),r);let f=t.num_values;for(const s of r)s===i&&f--;return f===0&&(r.length=0),{definitionLevels:r,numNulls:f}}function C(e,t,n,i){let r;const f=i==null?void 0:i[n];if(n==="UNCOMPRESSED")r=e;else if(f)r=f(e,t);else if(n==="SNAPPY")r=new Uint8Array(t),He(e,r);else throw new Error(`parquet unsupported compression codec: ${n}`);if((r==null?void 0:r.length)!==t)throw new Error(`parquet decompressed page length ${r==null?void 0:r.length} does not match header ${t}`);return r}function et(e,t,n){const r={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:f,element:s,schemaPath:o,codec:u,compressors:a}=n,l=t.data_page_header_v2;if(!l)throw new Error("parquet data page header v2 is undefined");const c=tt(r,l,o);r.offset=l.repetition_levels_byte_length;const _=nt(r,l,o),d=t.uncompressed_page_size-l.definition_levels_byte_length-l.repetition_levels_byte_length;let h=e.subarray(r.offset);l.is_compressed!==!1&&(h=C(h,d,u,a));const E=new DataView(h.buffer,h.byteOffset,h.byteLength),A={view:E,offset:0};let m;const w=l.num_values-l.num_nulls;if(l.encoding==="PLAIN")m=V(A,f,w,s.type_length);else if(l.encoding==="RLE")m=new Array(w),I(A,1,m),m=m.map(p=>!!p);else if(l.encoding==="PLAIN_DICTIONARY"||l.encoding==="RLE_DICTIONARY"){const p=E.getUint8(A.offset++);m=new Array(w),I(A,p,m,d-1)}else if(l.encoding==="DELTA_BINARY_PACKED")m=f==="INT32"?new Int32Array(w):new BigInt64Array(w),O(A,w,m);else if(l.encoding==="DELTA_LENGTH_BYTE_ARRAY")m=new Array(w),me(A,w,m);else if(l.encoding==="DELTA_BYTE_ARRAY")m=new Array(w),$e(A,w,m);else if(l.encoding==="BYTE_STREAM_SPLIT")m=Ae(r,w,f,s.type_length);else throw new Error(`parquet unsupported encoding: ${l.encoding}`);return{definitionLevels:_,repetitionLevels:c,dataPage:m}}function tt(e,t,n){const i=le(n);if(!i)return[];const r=new Array(t.num_values);return I(e,$(i),r,t.repetition_levels_byte_length),r}function nt(e,t,n){const i=Y(n);if(i){const r=new Array(t.num_values);return I(e,$(i),r,t.definition_levels_byte_length),r}}function rt(e,{groupStart:t,selectStart:n,selectEnd:i},r,f){const{columnName:s,schemaPath:o}=r,u=ue(o),a=[];let l,c,_=0;const d=f&&(()=>{c&&f({columnName:s,columnData:c,rowStart:t+_-c.length,rowEnd:t+_})});for(;(u?_<i:e.offset<e.view.byteLength-1)&&!(e.offset>=e.view.byteLength-1);){const h=it(e);if(h.type==="DICTIONARY_PAGE")l=J(e,h,r,l,void 0,0),l=re(l,r);else{const E=(c==null?void 0:c.length)||0,A=J(e,h,r,l,c,n-_);c===A?_+=A.length-E:(d==null||d(),a.push(A),_+=A.length,c=A)}}return d==null||d(),_>i&&c&&(a[a.length-1]=c.slice(0,i-(_-c.length))),a}function J(e,t,n,i,r,f){const{type:s,element:o,schemaPath:u,codec:a,compressors:l}=n,c=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){const _=t.data_page_header;if(!_)throw new Error("parquet data page header is undefined");if(f>_.num_values&&ue(u))return new Array(_.num_values);const d=C(c,Number(t.uncompressed_page_size),a,l),{definitionLevels:h,repetitionLevels:E,dataPage:A}=Ke(d,_,n);let m=Q(A,i,_.encoding,n);if(E.length||h!=null&&h.length){const w=Array.isArray(r)?r:[];return K(w,h,E,m,u)}else{for(let w=2;w<u.length;w++)u[w].element.repetition_type!=="REQUIRED"&&(m=Array.from(m,p=>[p]));return m}}else if(t.type==="DATA_PAGE_V2"){const _=t.data_page_header_v2;if(!_)throw new Error("parquet data page header v2 is undefined");if(f>_.num_rows)return new Array(_.num_values);const{definitionLevels:d,repetitionLevels:h,dataPage:E}=et(c,t,n),A=Q(E,i,_.encoding,n),m=Array.isArray(r)?r:[];return K(m,d,h,A,u)}else if(t.type==="DICTIONARY_PAGE"){const _=t.dictionary_page_header;if(!_)throw new Error("parquet dictionary page header is undefined");const d=C(c,Number(t.uncompressed_page_size),a,l),h={view:new DataView(d.buffer,d.byteOffset,d.byteLength),offset:0};return V(h,s,_.num_values,o.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function it(e){const t=ae(e),n=te[t.field_1],i=t.field_2,r=t.field_3,f=t.field_4,s=t.field_5&&{num_values:t.field_5.field_1,encoding:b[t.field_5.field_2],definition_level_encoding:b[t.field_5.field_3],repetition_level_encoding:b[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},o=t.field_6,u=t.field_7&&{num_values:t.field_7.field_1,encoding:b[t.field_7.field_2],is_sorted:t.field_7.field_3},a=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:b[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:i,compressed_page_size:r,crc:f,data_page_header:s,index_page_header:o,dictionary_page_header:u,data_page_header_v2:a}}function ft(e,{metadata:t,columns:n},i){const{file:r,compressors:f,utf8:s}=e,o=[],u={...ne,...e.parsers};for(const{file_path:a,meta_data:l}of i.rowGroup.columns){if(a)throw new Error("parquet file_path not supported");if(!l)throw new Error("parquet column metadata is undefined");const c=l.path_in_schema[0];if(n&&!n.includes(c))continue;const{startByte:_,endByte:d}=de(l),h=d-_;if(h>1<<30){console.warn(`parquet skipping huge column "${l.path_in_schema}" ${h} bytes`);continue}const E=Promise.resolve(r.slice(_,d));o.push({pathInSchema:l.path_in_schema,data:E.then(A=>{const m=oe(t.schema,l.path_in_schema),w={view:new DataView(A),offset:0},g={columnName:l.path_in_schema.join("."),type:l.type,element:m[m.length-1].element,schemaPath:m,codec:l.codec,parsers:u,compressors:f,utf8:s};return rt(w,i,g,e.onPage)})})}return{groupStart:i.groupStart,groupRows:i.groupRows,asyncColumns:o}}async function st({asyncColumns:e},t,n,i,r){const f=new Array(n),s=await Promise.all(e.map(({data:l})=>l.then(M))),o=e.map(l=>l.pathInSchema[0]).filter(l=>!i||i.includes(l)),u=i??o,a=u.map(l=>e.findIndex(c=>c.pathInSchema[0]===l));for(let l=t;l<n;l++)if(r==="object"){const c={};for(let _=0;_<e.length;_++)c[e[_].pathInSchema[0]]=s[_][l];f[l]=c}else{const c=new Array(e.length);for(let _=0;_<u.length;_++)a[_]>=0&&(c[_]=s[a[_]][l]);f[l]=c}return f}function ge(e,t){const{asyncColumns:n}=e,i=[];for(const r of t.children)if(r.children.length){const f=n.filter(u=>u.pathInSchema[0]===r.element.name);if(!f.length)continue;const s=new Map,o=Promise.all(f.map(u=>u.data.then(a=>{s.set(u.pathInSchema.join("."),M(a))}))).then(()=>{T(s,r);const u=s.get(r.path.join("."));if(!u)throw new Error("parquet column data not assembled");return[u]});i.push({pathInSchema:r.path,data:o})}else{const f=n.find(s=>s.pathInSchema[0]===r.element.name);f&&i.push(f)}return{...e,asyncColumns:i}}async function ot(e){e.metadata??(e.metadata=await x(e.file));const t=Ee(e),{rowStart:n=0,rowEnd:i,columns:r,onChunk:f,onComplete:s,rowFormat:o}=e;if(!s&&!f){for(const{asyncColumns:l}of t)for(const{data:c}of l)await c;return}const u=k(e.metadata),a=t.map(l=>ge(l,u));if(f)for(const l of a)for(const c of l.asyncColumns)c.data.then(_=>{let d=l.groupStart;for(const h of _)f({columnName:c.pathInSchema[0],columnData:h,rowStart:d,rowEnd:d+h.length}),d+=h.length});if(s){const l=[];for(const c of a){const _=Math.max(n-c.groupStart,0),d=Math.min((i??1/0)-c.groupStart,c.groupRows),h=await st(c,_,d,r,o);j(l,h.slice(_,d))}s(l)}else for(const{asyncColumns:l}of a)for(const{data:c}of l)await c}function Ee(e){if(!e.metadata)throw new Error("parquet requires metadata");const t=Me(e);return e.file=xe(e.file,t),t.groups.map(n=>ft(e,t,n))}async function lt(e){var f;if(((f=e.columns)==null?void 0:f.length)!==1)throw new Error("parquetReadColumn expected columns: [columnName]");e.metadata??(e.metadata=await x(e.file));const t=Ee(e),n=k(e.metadata),i=t.map(s=>ge(s,n)),r=[];for(const s of i)r.push(M(await s.asyncColumns[0].data));return M(r)}function B(e){return new Promise((t,n)=>{ot({rowFormat:"object",...e,onComplete:t}).catch(n)})}async function ct(e){if(!e.file||!(e.file.byteLength>=0))throw new Error("parquet expected AsyncBuffer");e.metadata??(e.metadata=await x(e.file));const{metadata:t,rowStart:n=0,columns:i,orderBy:r,filter:f}=e;if(n<0)throw new Error("parquet rowStart must be positive");const s=e.rowEnd??Number(t.num_rows),o=U(f),u=k(e.metadata).children.map(_=>_.element.name),a=o.filter(_=>!u.includes(_));if(a.length)throw new Error(`parquet filter columns not found: ${a.join(", ")}`);if(r&&!u.includes(r))throw new Error(`parquet orderBy column not found: ${r}`);const l=i?u.filter(_=>i.includes(_)||o.includes(_)||_===r):void 0,c=i&&l?i.length<l.length:!1;if(f&&!r&&s<t.num_rows){const _=new Array;let d=0;for(const h of t.row_groups){const E=d+Number(h.num_rows),A=await B({...e,rowFormat:"object",rowStart:d,rowEnd:E,columns:l});for(const m of A)if(L(m,f)){if(c&&l)for(const w of l)i&&!i.includes(w)&&delete m[w];_.push(m)}if(_.length>=s)break;d=E}return _.slice(n,s)}else if(f){const _=await B({...e,rowFormat:"object",rowStart:void 0,rowEnd:void 0,columns:l});r&&_.sort((h,E)=>ee(h[r],E[r]));const d=new Array;for(const h of _)if(L(h,f)){if(c&&l)for(const E of l)i&&!i.includes(E)&&delete h[E];d.push(h)}return d.slice(n,s)}else if(typeof r=="string"){const _=await lt({...e,rowStart:void 0,rowEnd:void 0,columns:[r]}),d=Array.from(_,(A,m)=>m).sort((A,m)=>ee(_[A],_[m])).slice(n,s),h=await ut({...e,rows:d});return d.map(A=>h[A])}else return await B(e)}async function ut(e){const{file:t,rows:n}=e;e.metadata||(e.metadata=await x(t));const{row_groups:i}=e.metadata,r=Array(i.length).fill(!1);let f=0;const s=i.map(l=>f+=Number(l.num_rows));for(const l of n){const c=s.findIndex(_=>l<_);r[c]=!0}const o=[];let u;f=0;for(let l=0;l<r.length;l++){const c=f+Number(i[l].num_rows);r[l]?u===void 0&&(u=f):u!==void 0&&(o.push([u,c]),u=void 0),f=c}u!==void 0&&o.push([u,f]);const a=new Array(Number(e.metadata.num_rows));for(const[l,c]of o){const _=await B({...e,rowStart:l,rowEnd:c});for(let d=l;d<c;d++)a[d]=_[d-l],a[d].__index__=d}return a}function ee(e,t){return e<t?-1:e>t?1:0}function L(e,t={}){return"$and"in t&&Array.isArray(t.$and)?t.$and.every(n=>L(e,n)):"$or"in t&&Array.isArray(t.$or)?t.$or.some(n=>L(e,n)):"$nor"in t&&Array.isArray(t.$nor)?!t.$nor.some(n=>L(e,n)):Object.entries(t).every(([n,i])=>{const r=e[n];return typeof i!="object"||i===null||Array.isArray(i)?N(r,i):Object.entries(i||{}).every(([f,s])=>{switch(f){case"$gt":return r>s;case"$gte":return r>=s;case"$lt":return r<s;case"$lte":return r<=s;case"$eq":return N(r,s);case"$ne":return!N(r,s);case"$in":return Array.isArray(s)&&s.includes(r);case"$nin":return Array.isArray(s)&&!s.includes(r);case"$not":return!L({[n]:r},{[n]:s});default:return!0}})})}function U(e){if(!e)return[];const t=[];return"$and"in e&&Array.isArray(e.$and)?t.push(...e.$and.flatMap(U)):"$or"in e&&Array.isArray(e.$or)?t.push(...e.$or.flatMap(U)):"$nor"in e&&Array.isArray(e.$nor)?t.push(...e.$nor.flatMap(U)):t.push(...Object.keys(e)),t}export{at as asyncBufferFromUrl,Be as byteLengthFromUrl,M as flatten,Z as parquetMetadata,x as parquetMetadataAsync,ct as parquetQuery,ot as parquetRead,B as parquetReadObjects,k as parquetSchema,He as snappyUncompress};
